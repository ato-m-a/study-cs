# JS 이벤트 루프

자바스크립트는 단일 스레드 기반 언어로, 자바스크립트 엔진이 단일 콜 스택을 갖습니다. 이로 인해 요청이 동기적으로 처리됩니다.

자바스크립트에서 비동기 요청은 실행 환경인 브라우저나 `Node.js` 와 같은 런타임 환경에서 담당하게 됩니다. 여기서 자바스크립트
엔진과 그 실행 환경을 상호 연동시켜주는 장치가 바로 **이벤트 루프** 입니다. 따라서, 이벤트 루프는 자바스크립트 엔진에 있지 않고
그 환경에 속합니다.

<br>

## 태스크 큐와 마이크로태스크 큐

자바스크립트의 실행 환경은 2가지 큐를 가지고 있으며 각각 **스크립트 실행, 이벤트 핸들러, 콜백함수 등의 태스크**가 담기는 공간입니다.

태스크가 콜백함수라면 그 종류에 따라 다른 큐에 담기며, 대표적인 예로는 다음과 같은 것들이 있습니다.

- **태스크 큐**
  - `setTimeout()`, `setInterval()`, `requestAnimationFrame()`, UI 렌더링

- **마이크로태스크 큐**
  - `Promise`, `MutationObserver`
  - 여기서, `MutationObserver` 는 브라우저에서 DOM의 변화를 감지하는 API입니다.

이벤트 루프는 2개의 큐를 감시하고 있다가 콜 스택에 비게 되면, 콜백함수를 꺼내와서 실행합니다. 이 때 마이크로태스크 큐의 콜백함수가
우선순위를 가지기 때문에 마이크로태스크 큐의 콜백함수를 모두 실행한 후 태스크 큐의 콜백함수들을 실행합니다.

(단, UI 렌더링이 태스크 큐에 속하기 때문에 마이크로태스크 큐의 태스크가 많으면 렌더링이 지연될 수 있습니다.)

<br>

## 구조

1. **힙 (Heap)**: 메모리가 할당되는 곳(선언한 변수 및 함수)
2. **콜 스택 (Call Stack)**: 코드가 실행되는 곳(스택-후입선출) 실행되면 새로운 프레임을 생성하고, 처리가 끝나면 제거
3. **콜백 큐 (Callback Queue)**: 선입선출으로 비동기적으로 실행된 콜백 함수가 보관되는 곳. 콜 스택에 가기위한 대기열.
  - **태스크 큐 (Task Queue)**: `setTimeout()`, `setInterval()`
  - **마이크로태스크 큐 (Microtask Queue)**: `Promise` (`async/await`), `MutationObserver`
  - **애니메이션 프레임 (Animation Frame)**: `requestAnimationFrame()`
  - 우선 순위는 **Microtask Queue** > **Animation Frame** > **Task Queue** 순입니다.

정리하자면, **Call Stack**과 **Callback Queue**의 상태를 계속 감시하며, **Call Stack**에 함수가 존재하지 않는다면
**Callback Queue**에 있는 비동기 함수들을 **Call Stack**에 밀어넣고, 비동기 함수를 실행시키게 됩니다.